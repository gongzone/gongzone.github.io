---
title: 'YarnBerry에 대해'
description: '단진자(Simple Pendulum) 운동을 발생시키는 힘의 요소에 대해 알아보고, 어떻게 구현할 것인지 생각해봅니다.'
slug: '13'
image: './assets/yarnberry.png'
category: '기타'
tags: ['Canvas', 'YarnBerry']
date: '2022-03-30'
series: '시리즈1'
---

import { GatsbyImage, getImage } from 'gatsby-plugin-image';

<div>
  새삼 훌륭하신 개발자 분들에게 감사를 표하고 싶어지는 밤입니다. 그들 덕분에 개발 생태계가
  풍요로워졌으니까요. 저도 언젠가 보탬이 되었으면 하면서 글을 시작합니다.
</div>

### 1. 패키지 매니저란?

프로젝트를 진행하면서 모든 기능을 나 혼자만의 힘으로 구현하고자 하는 것은 굉장히 지치고 어려운 일이 될 것입니다.
만약 외부 생태계에서 목적에 맞는 적절한 기술을 끌어다가 사용할 수 있다면 개발의 속도나 퀄리티 측면에서 더 좋은 퍼포먼스를 발휘할 수 있겠죠.

그렇다면 **외부의 패키지화된 기술(라이브러리)들을 사용하고 관리할 수 있는 적절한 도구**가 필요한데,
바로 그것이 이 글에서 다뤄볼 **‘패키지 매니저’**입니다. 패키지 매니저에 대한 개인적인 감상으로는,
외부 생태계와 내 로컬 프로젝트를 연결시키는 일종의 인터페이스 같다는 느낌을 받았습니다.

패키지 매니저 또한 누군가 개발한 하나의 소프트웨어로서, 각각의 운영체제마다 혹은 프로그래밍 언어마다 구분되어 존재하기에,
이 글에서는 자바스크립트 기반 Node.js 패키지 매니저에 초점을 맞춰 살펴보겠습니다.

<div display="info">
  <p>
    <strong>패키지 매니저(package manager)</strong>: 외부 기술(라이브러리)을 내 프로젝트에 사용하고
    관리하는데 도움을 주는 도구, 혹은 내 프로젝트의{' '}
    <strong>의존성(dependencies)을 관리하는 시스템</strong>이라고 할 수 있습니다.
  </p>
</div>

### 2. Node.js 패키지 매니저

대표적인 Node.js 기반 패키지 매니저로는 npm과 yarn이 있습니다.

#### (1) npm (node package manager)

<ul>
  <li>
    ◼ npm은 자바스크립트 런타임인 Node.js를 설치하게 되면 자동적으로 사용할 수 있는 디폴트 패키지
    매니저입니다.
  </li>
  <li>
    ◼ npm은 초기에 그렇다할 경쟁자가 없었기에 개발자들로부터 아래와 같은 문제점을 지적당했으나 빠른
    업데이트가 이루어지지 않았습니다.
    <div>
      <ol>
        <li>전반적인 패키지 설치 프로세스가 굉장히 느리다.</li>
        <li>
          cache의 이점을 제대로 활용하지 않아 첫번째 설치와 두 번째 설치간의 속도 차이가 거의
          없었다.
        </li>
        <li>
          lock file이 자동적으로 생성되지 않아 <inlineCode>npm shrinkwrap</inlineCode> 명령어로 해당
          프로젝트의 의존성 버전을 고정시켜야 했다.
        </li>
      </ol>
    </div>
  </li>
  <li>◼ yarn이 출시된 이후 현재 npm은 많은 개선과정을 거쳐 기존 문제점 다수를 해결하였습니다.</li>
</ul>

#### (2) yarn (yet another resource negotiator) v1

<ul>
  <li>◼ yarn은 Facebook에서 2016년에 출시한 패키지 매니저입니다.</li>
  <li>
    ◼ yarn은 위에서 언급한 npm의 고질적 문제를 해결한 솔루션이였기에, 많은 개발자들이 npm에서 yarn을
    이용하는 것으로 옮겨갔습니다.
  </li>
  <li>
    ◼ yarn 역시 기존 npm registry(패키지 에코시스템)를 사용할 수 있었기에, npm에서 yarn으로 쉽게
    전환할 수 있었습니다.
  </li>
  <li>◼ yarn version 1(Classic)은 공식적으로 지원이 중지된 상태입니다.</li>
</ul>

#### (3) 새로운 패키지 매니저: yarn v2+, pnpm

◼ npm과 yarn v1은 현재에 와서 특정 성능이나 기능이 다소 다를지라도,
기본적으로 같은 맥락을 공유하고 있습니다. 바로 **node_modules 폴더를 중심으로 패키지를 관리**한다는 것입니다.

◼ 이러한 환경에서 패키지를 관리하다보니 다양한 문제점들이 발견되었기에 새로운 방식의 패키지 매니저가 등장하게 되었습니다.
대표적으로 version 2 이상의 yarn(yarn berry)과 pnpm이 있습니다.

◼ 모던 프론트엔드 환경 구축을 위해 알아두면 좋은 주제이기에,
다음 문단에서 yarn v2+ (yarn berry)를 중심으로 관련 내용을 자세히 작성해보도록 하겠습니다.

<div display="info">
1️⃣ <strong>npx와 dlx</strong> <br />
<p>React를 처음 접할 때 다음과 같은 명령어를 많이 보셨을겁니다.</p>

<p>
  <div>npx create-react-app</div>
</p>

<ul>
  <li>
    ◼ npx(node package execute)는 5.2.0 version 이상의 npm을 설치할 시 자동적으로 설치가 되는 CLI
    도구입니다.
  </li>
  <li>
    ◼ npx은 간단히 말해서, <strong> 특정 패키지를 실행시키는 역할을 수행</strong>
    합니다. <strong>심지어 node_modules 폴더에 필요한 의존성을 설치하지 않더라도 말이죠.</strong>
  </li>
  <li>
    ◼ 따라서 보통의 경우 버전 업데이트가 잦은 모듈을 npm registry에 접근하여{' '}
    <strong>일회성 명령</strong>으로 실행시킬 때 주로 사용합니다.
  </li>
  <li>◼ npm에 npx가 있다면 yarn에는 그와 같은 유사한 도구로 dlx가 존재합니다. </li>
</ul>

2️⃣ <strong>nvm</strong> <br />

<ul>
  <li>◼ Node.js를 여러버전으로 설치해서 관리하게 해주는 도구입니다.</li>
  <li>
    ◼ 협업시 같은 Node 버전으로 맞춰서 진행한다거나 다양한 Node 버전의 프로젝트를 동시에 진행할 때
    사용합니다.
  </li>
</ul>

</div>

### 3. yarn v2+(yarn berry)

#### (1) 기존 npm과 yarn v1의 문제점: node_modules

어떤 새로운 기술이 등장했을 때, 우리가 먼저 살펴볼 사항은 **‘어떤 문제를 해결하기 위한 솔루션인가?’** 를 파악하는 것입니다.

yarn berry 역시 기존 문제를 해결하기 위해 나타났습니다.
즉, **node_modules 폴더에 의존성 파일들을 생성하여 관리하는 방식을 회피**하고자 yarn berry가 탄생한 것이죠.
그렇다면 node_modules 폴더에는 어떤 문제점들이 있었을까요?

##### 1️⃣ 거대하고 복잡하다.

🔸 node_modules 폴더는 작은 프로젝트를 진행하더라도 용량이 크기 때문에
보통 .gitignore 파일에 추가하여 원격 리포에 올라가지 않게 하는 것이 일반적입니다. (굉장히 오랜시간이 걸리므로)
이말인즉슨, **많은 양의 디스크 용량을 차지함으로 자원의 낭비를 발생**시킨다는 것입니다.

🔸 의존성들은 서로가 서로를 의존하며 깊이가 깊은 의존성 트리 구조를 만들어내는데,
이 상태에서 패키지 매니저가 **복잡한 의존성들을 잘 관리하고 확인하기 위해서는 많은 양의 시스템 호출이 요구**되어집니다.

🔸 즉, node_modules 폴더를 **I/O-heavy operation를 통해 생성하는 작업은 비효율적**으로 일어날 수 밖에 없고,
결국 시간을 많이 잡아먹게 되는 문제점이 있습니다.

##### 2️⃣ 최적화의 어려움.

🔸 위와 같이 node_modules 폴더의 설계 자체가 문제가 있기 때문에, **같은 패키지를 중복으로 설치할 위험이 존재**합니다.

🔸 기존 패키지 매니저들은 hoisting 알고리즘을 통해 중복 설치를 방지하고자 하나,
특정 패턴에는 적용되지 못하며, 적용되었다고 해도 **유령 의존성 (Phantom Dependency)**의 문제가 발생할 수 있습니다.

<div display="warning">

<p>
  <strong>유령의존성 👻</strong>
</p>
<p>
  <strong>
    package.json에 명시해 놓지 않았으나(내 프로젝트가 직접 의존하지 않으나) 사용할 수 있는 의존성을
    말합니다.
  </strong>
</p>
<p>
  hoisting을 통하여 어떤 의존성 A가 의존하는 의존성 B가 중복되어 트리 구조 상 끌어 올라와졌을 때,
  우리는 그 의존성 B를 직접 사용할 수 있게 됩니다. 그리고 의존성 A를 삭제한 순간 의존성 B도 조용히
  사라져 사용할 수 없게 됩니다.
</p>
<p>
  이러한 <strong>통제와 예측이 불가능한 상황을 야기할 수 있기에</strong> 유령 의존성은 문제가 될 수
  있습니다.
</p>
</div>

#### (2) Yarn berry의 특징

상기한 node_modules관련 문제들을 yarn berry에서는 **Plug’n’Play (PnP)**과 **Zero-Installs**를 도입하여 해결하였습니다.

##### 1️⃣ Plug’n’Play (PnP)

- ◼ nested folder structure(복잡한 구조)인 node_modules 폴더를 만들지 않고, 단순히 **.pnp.cjs** 파일을 생성합니다.
- ◼ .pnp.cjs 파일은 **Node가 의존성을 쉽게 찾을 수 있게하는 정보**를 담고 있습니다. (lookup table)
  예를들어, 해당 패키지의 이름과 버전, 경로에 대한 정보를 담고 있으며,
  거기에 더 나아가 해당 패키지가 어떤 패키지에 의존하는지 그리고 그 패키지들의 버전 정보를 명시하고 있습니다.
- ◼ .pnp.cjs 파일을 이용하면 디스크 I/O에 크게 의존하지 않아도 되기 때문에, 안정적이며 더욱 속도가 빠를 수 밖에 없습니다.
- ◼ Node가 의존성 검색을 위해 파일시스템 계층을 반복하며 탐색할 필요가 없어졌기 때문에 애플리케이션 구동이 빨라집니다.
- ◼ 의존성 트리에 대한 완벽한 최적화가 가능하며, 예측가능해집니다.

##### 2️⃣ Zero-Installs

- ◼ yarn berry는 의존성 관리를 **.yarn/cache** 디렉토리내에 **zip파일**로 관리를 합니다.
- ◼ 하나의 패키지 당 하나의 zip파일로 구성됩니다.
- ◼ yarn 공식 홈페이지에 따르면 1.2GB의 압축되지 않은 node_modules 폴더를 대략 139MB의 zip 파일들로 구축할 수 있다고 나와있습니다.
  전자는 git에서 지원하지 않는 용량이지만, 후자는 지원하기에 원격 리포에 push가 가능합니다.
  따라서 다른 개발자가 별도로 yarn install를 할 필요가 없이 셋팅된 프로젝트를 그대로 받아올 수 있음을 의미합니다.
- ◼ 어떤 패키지를 지우거나 업데이트 할 시, 단 하나의 파일의 변화만 생기기 때문에 속도가 빠르고 안정적입니다.
  (기존 node_modules에서는 많은 파일들이 지워지거나 새로 생성되어야 했기 때문에 비효율적이였습니다.)

<div>
  실무에서도 yarn berry를 적용하는 사례들을 확인할 수 있습니다. <br />

  <a href="https://toss.tech/article/node-modules-and-yarn-berry">- 토스 기술 블로그</a> <br/>
  <a href="https://medium.com/wantedjobs/yarn-berry-%EC%A0%81%EC%9A%A9%EA%B8%B0-1-e4347be5987">- 원티드 제품 팀 블로그</a>
</div>

#### (3) yarn berry 내 프로젝트에 적용하기

##### 1️⃣ 기본 설정

yarn berry를 내 프로젝트에 적용하는 것 자체는 굉장히 간단합니다.
Node와 npm이 미리 설치되었다고 가정하면 다음 몇 줄의 커맨드로 yarn berry의 **Plug’n’Play** 기능을 사용하실 수 있습니다.

```bash
$ npm install -g yarn
$ yarn set version berry
```

눈 여겨 볼 만한 점은, 기존 npm과 yarn classic과 다르게 패키지 매니저 버전을 프로젝트(혹은 패키지) 별로 설정한다는 것입니다.
만약 기존에 node_modules 폴더와 package-lock.json 파일이 존재하는 프로젝트에 yarn berry를 적용하시려면
미리 해당 폴더와 파일을 삭제하시고 적용하시길 바랍니다.

해당 프로젝트에 yarn berry가 적용되었는지 확인하시려면 `yarn -v` 명령어를 통해 yarn의 버전을 확인하시면 됩니다.
작성일 기준 yarn 버전은 3.2.0 입니다.

##### 2️⃣ .gitignore 설정

기존 패키지 매니저에서는 node_modules 폴더를 ignore 시키는게 일반적이였습니다. yarn berry의 경우는 아래와 같습니다.

[Which file should be ignored? - yarn 공식 홈페이지](https://yarnpkg.com/getting-started/qa#which-files-should-be-gitignored)

🔺 Zero-Installs 사용 시

<div>
  .yarn/* <br />
  !.yarn/cache <br />
  !.yarn/patches <br />
  !.yarn/plugins <br />
  !.yarn/releases <br />
  !.yarn/sdks <br />
  !.yarn/versions <br />
</div>

🔺 Zero-Installs를 사용하지 않을 시

<div>
  .pnp.* <br />
  .yarn/* <br />
  !.yarn/patches <br />
  !.yarn/plugins <br />
  !.yarn/releases <br />
  !.yarn/sdks <br />
  !.yarn/versions <br />
</div>

Zero-Installs의 핵심은 프로젝트를 원격 레포를 통해 받아왔을 때, yarn install을 사용하지 않고 받아온 그대로 사용할 수 있다는 점입니다.
따라서 Zero-Installs를 사용할 때는 .pnp.\* 파일들과 .yarn/cache 폴더를 원격 레포로 올릴 필요가 있습니다.(무시하지 않음).

##### 3️⃣ VSCode SDKs 설정

VSCode의 경우, **Plug’n’Play** 기능을 원활히 사용하기 위해서 별도의 설정이 필요하기도 합니다.
대표적으로 typescript, eslint, prettier를 사용하는 경우에 말이죠.
만약 SDKs 설정을 하지 않으면 타입 체킹이나 에러 체킹이 정상적으로 이루어지지 않고 포맷 기능도 활성화 되지 않는 상황을 맞닥뜨릴 수 있습니다.

[Editor SDKs - yarn 공식 홈페이지](https://yarnpkg.com/getting-started/editor-sdks)

**1) 먼저 typescript와 eslint, prettier를 package.json dependencies에 추가합니다.**

```bash
$ yarn add -D typescript eslint prettier
```

**2) [ZipFS 링크](https://marketplace.visualstudio.com/items?itemName=arcanis.vscode-zipfs)라는 VSCode 확장 프로그램을 설치합니다.**

**3) 아래의 명령어를 사용하여 .yarn/sdks 폴더를 생성합니다.**

```bash
$ yarn dlx @yarnpkg/sdks vscode
```

**4) typescript 파일 안에서 ctrl+shift+p 눌러 “Select TypeScript Version” 입력하고 선택합니다.**

**5) "Use Workspace Version” 을 선택합니다.**

##### 4️⃣ typescript plugin 설치 (option)

yarn berry는 plugin을 통하여 그 기능을 확장할 수 있습니다.
그 중 유용한 typescript plugin을 설치하여 보겠습니다.
이 플러그인은 자체적으로 타입을 포함하지 않은 패키지를 설치할 때 자동적으로 그와 관련된 @types 패키지들을 설치할 수 있도록 도와줍니다.

```bash
$ yarn plugin import typescript
```

##### 5️⃣ 적용 시 발생한 문제

저의 경우 코드 템플릿을 만들고 있는 폴더에 yarn berry를 적용해보았습니다. (기존에는 npm을 이용)

webpack + typescript + eslint + prettier + husky 정도로 환경 셋팅을 끝마친 경우에 적용하였는데, 타입 체킹, 문법 에러 체킹, 포맷팅이 정상적으로 이루어지지 않아 (대표적으로 Cannot find module...문제) 이틀 동안 골머리를 앓았습니다. (수 없이 반복한 구글링의 향연...😰)

저는 VSCode SDKs 설정 부분에서 **"Use Workspace Version”을 선택하는 창이 뜨지 않았기 때문에**
이것이 어느정도 문제일 가능성이 높다고 생각은 하였으나 구체적인 해결방법은 찾지 못한 상태였습니다.
그러던 와중 yarn dlx @yarnpkg/sdks vscode 명령어를 치면 .vscode 폴더 역시 생성되는데
이 안에 있는 settings.json 설정 파일이 내 프로젝트에 적용되지 않는 문제가 아닐까 생각이 되었습니다.

즉, 저는 보통의 경우 다음과 같이 workspace라는 폴더(상위 폴더)를 open하여 작업을 하는데,
(이런 경우, 글로벌한 vscode 셋팅이 적용되는거 같습니다.)

제가 작업하고 있는 폴더를 직접 open한다면 (저의 경우 vanillajs 폴더)

그 안에 존재하는 vscode 셋팅이 해당 폴더에 제대로 적용되지 않을까하는 생각이 든 것입니다.

**빙고! 🎉**

ctrl+shift+p를 눌러 타입스크립트 버전 선택을 눌러보니 **"Use Workspace Version”** 뜨는 것을 확인하였고
상기했던 문제들이 해결됨을 확인할 수 있었습니다.

### 4. 마무리

**Plug’n’Play** 은 기존 의존성 관리 시스템의 방향을 따르지 않고 있기 때문에 올바른 사용을 위해서는 추가적인 환경 설정이 개발자에게 요구가 됩니다.

혹은 호환성 문제로 인하여 아직까지 지원이 되지 않는 영역 또한 존재하고 있습니다. (대표적으로 React Native, 작성일 기준)

큰 프로젝트를 yarn berry로 다루어 보진 않아서 어떤 문제들이 존재하고 있을지 예측하기는 어렵지만 , 개인적으로 yarn berry의 적용함으로서 얻는 이점들은 충분히 설득력이 있다고 생각합니다.

앞으로 저는 yarn berry workspace 기능을 통하여 monorepo를 구축해볼 생각이며, 더불어 테스트 환경 조성까지 마쳐볼 생각입니다. 이 정도 진행하면 프로젝트 셋업을 위한 기초적인 부분들은 어느 정도 다뤄본 셈이겠네요.

누군가에게 이 글이 도움되었으면 하는 바램과 함께 글을 마치도록 하겠습니다. 감사합니다.
